<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Snap to Road</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        #map { height: 100vh; }
        .car-icon { transform-origin:center; }
    </style>
</head>
<body>

<div id="map"></div>

<script>
var map = L.map('map').setView([0, 0], 16);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

var carIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/854/854992.png",
    iconSize: [40, 40],
    className: "car-icon"
});

var marker = L.marker([0,0], { icon: carIcon }).addTo(map);

// Smoothing
let lastLatLng = null;

function smoothMove(from, to, duration = 300){
    let start = performance.now();

    function animate(now){
        let progress = (now - start) / duration;
        if(progress > 1) progress = 1;

        let lat = from.lat + (to.lat - from.lat) * progress;
        let lng = from.lng + (to.lng - from.lng) * progress;

        marker.setLatLng([lat, lng]);
        map.panTo([lat, lng], { animate: true });

        if(progress < 1){
            requestAnimationFrame(animate);
        }
    }

    requestAnimationFrame(animate);
}

navigator.geolocation.watchPosition(async (pos) => {
    let lat = pos.coords.latitude;
    let lng = pos.coords.longitude;

    let heading = pos.coords.heading || 0;

    // Snap-to-road via OSRM Map Matching
    let url = `https://router.project-osrm.org/match/v1/driving/${lng},${lat}?geometries=geojson&overview=simplified`;

    let res = await fetch(url);
    let data = await res.json();

    if(data.matchings && data.matchings[0]){
        let snapped = data.matchings[0].geometry.coordinates[0];
        let snappedLat = snapped[1];
        let snappedLng = snapped[0];

        marker._icon.style.transform = `rotate(${heading}deg)`;

        if(lastLatLng){
            smoothMove(lastLatLng, L.latLng(snappedLat, snappedLng));
        } else {
            marker.setLatLng([snappedLat, snappedLng]);
            map.setView([snappedLat, snappedLng]);
        }

        lastLatLng = L.latLng(snappedLat, snappedLng);
    }

}, 
(err) => console.log(err),
{ enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
);
</script>

</body>
</html>
